<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用mouseover事件冒泡阶段模拟mouseenter事件</title>
    <style>
        .wrap {
            width: 50%;
            box-sizing: border-box;
            float: left;
        }

        .wrap, .list {
            border: solid 1px green;
            padding: 30px;
            margin: 30px 0;
        }

        .list {
            border: solid 1px red;
        }

        .list li {
            border: solid 1px blue;
            padding: 10px;
            margin: 10px;
        }

        .count {
            color: red;
        }
    </style>
</head>
<body>
<div class="wrap">
    mouseenter
    <ul class="mouseenter list">
        count: <span class="count"></span>
        <li>1</li>
        <li>2</li>
        <li>3</li>
    </ul>
</div>

<div id="emulate-mouseenter-wrap" class="wrap">
    用mouseover模拟实现mouseenter
    <ul class="emulate-mouseenter list">
        count: <span class="count"></span>
        <!--<li style="width: 525px">1</li> 制造超出祖父元素层-->
        <li>1</li>
        <li>2</li>
        <li>3</li>
    </ul>
</div>
</body>
<script>
    let docEle = document.documentElement
    let contains = docEle.contains ? function (parent, node) {
        return parent !== node && parent.contains(node)
    } : function (parent, node) {
        let result = parent !== node

        if (!result) { // 排除parent与node传入相同的节点
            return result
        }

        if (result) {
            while (node && (node = node.parentNode)) {
                if (parent === node) {
                    return true
                }
            }
        }

        return false
    }


    let $mouseenter = document.querySelector('.mouseenter')
    let $emulateMouseenter = document.querySelector('.emulate-mouseenter')

    let $enterCount = document.querySelector('.mouseenter .count')
    let $emulateMouseenterCounter = document.querySelector('.emulate-mouseenter .count')

    let addCount = function (ele, start = 0) {
        return function () {
            ele.innerHTML = ++start
        }
    }

    let emulateMouseenterCallback = addCount($emulateMouseenterCounter)

    let emulateEnterOrLeave = function (callback) {
        return function (e) {
            let relatedTarget = e.relatedTarget
            //当子元素超出父元素后，到达比父元素更高层的元素时，结果为false，利用这种方式判断是否调用callback是不可取的
            //当子元素超出父元素后，到达比父元素更高层的元素时，理想情况下，如果鼠标在子元素上悬浮也应该执行callback
            console.log('e.relatedTarget === this.parentNode:', e.relatedTarget === this.parentNode)

            //this指向绑定事件的DOM节点也就是currentTarget,也就是ul节点
//            e.relatedTarget !== target(目标元素)
//            console.log(this);

            //relatedTarget不为目标节点，并且relatedTarget不为目标节点的子节点
//            if (relatedTarget !== this && !contains(this, relatedTarget)) {
            if (!this.contains(relatedTarget)) {//改进版
                callback.apply(this, arguments)
                return
            }
        }
    }


    //mouseenter 、mouseleave 不支持事件的冒泡，最后一个参数false表示在冒泡阶段调用处理程序
    //因此，这两个事件的冒泡处理也可以分别用 mouseover 和 mouseout 来模拟。
//    $mouseenter.addEventListener('mouseenter', addCount($enterCount), false)

    //mouseover、mouseout支持冒泡
//    $emulateMouseenter.addEventListener('mouseover', emulateEnterOrLeave(emulateMouseenterCallback), false)



    //    $emulateMouseenter.addEventListener('mouseover', addCount($emulateMouseenterCounter), false)

    //    Array.prototype.slice.call($emulateMouseenter.querySelectorAll('li')).forEach(function (li) {
    //        li.addEventListener('mouseover',function (event) {
    //            event.stopPropagation();
    //        })
    //    })


    //事件委托
    function emulateMouseenterDelegation() {
        let $emulateMouseenterWrap = document.querySelector('#emulate-mouseenter-wrap')
        let $emulateMouseenter = document.querySelector('.emulate-mouseenter')

        let emulateEnterOrLeave =  function(callback) {
            return function (event) {
                if (event.target === $emulateMouseenter) {
//                    console.log('event.currentTarget:',event.currentTarget.id)
//                    console.log('event.target:',event.target.id)

                    let relatedTarget = event.relatedTarget,
                        $this = $emulateMouseenter

                    if(!$this.contains(relatedTarget)){
                        callback.call($this,arguments)
                    }
                }
            }
        }

        $emulateMouseenterWrap.addEventListener('mouseover', emulateEnterOrLeave(emulateMouseenterCallback), false)
    }
    emulateMouseenterDelegation()
</script>
</html>